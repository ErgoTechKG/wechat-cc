---
title: å¾®ä¿¡å¥½å‹ â†’ Claude Code (Docker æ²™ç®±éš”ç¦»)
---
sequenceDiagram
    participant A as å¥½å‹A (normal)
    participant B as å¥½å‹B (trusted)
    participant C as ç®¡ç†å‘˜
    participant W as å¾®ä¿¡Bot
    participant R as æ¶ˆæ¯è·¯ç”±å™¨
    participant DM as Docker Manager
    participant DA as ğŸ³ å®¹å™¨A<br/>å†…å­˜512M CPU1<br/>ç½‘ç»œ:none
    participant DB as ğŸ³ å®¹å™¨B<br/>å†…å­˜512M CPU1<br/>ç½‘ç»œ:limited
    participant DC as ğŸ³ å®¹å™¨C<br/>å†…å­˜2G CPU2<br/>ç½‘ç»œ:bridge

    Note over DM: å¯åŠ¨æ—¶æ£€æŸ¥:<br/>Dockerå¯ç”¨ âœ“<br/>æ²™ç®±é•œåƒ âœ“<br/>ç½‘ç»œåˆå§‹åŒ– âœ“

    A->>W: "å¸®æˆ‘è§£é‡Šå¿«æ’ç®—æ³•"
    W->>R: {wxid_A, msg}
    R->>R: æƒé™æ£€æŸ¥ â†’ normal
    R->>R: é€Ÿç‡é™åˆ¶ â†’ âœ…
    R->>DM: ensureContainer(wxid_A, normal)
    DM->>DM: å®¹å™¨ä¸å­˜åœ¨ â†’ åˆ›å»º
    Note over DM: docker create<br/>--memory 512m<br/>--cpus 1<br/>--network none<br/>--read-only<br/>--cap-drop ALL<br/>-v data/wxid_A/workspace:/workspace
    DM->>DA: docker start
    R->>DA: docker exec claude --print msg
    Note over DA: Claudeè¿è¡Œåœ¨å®¹å™¨å†…<br/>non-rootç”¨æˆ·<br/>æ— ç½‘ç»œè®¿é—®<br/>åªèƒ½è¯»å†™ /workspace
    DA-->>R: "å¿«æ’æ˜¯ä¸€ç§åˆ†æ²»ç®—æ³•..."
    R-->>W: å›å¤
    W-->>A: "å¿«æ’æ˜¯ä¸€ç§åˆ†æ²»ç®—æ³•..."

    B->>W: "å¸®æˆ‘å†™ä¸ªPythonçˆ¬è™«å¹¶è¿è¡Œ"
    W->>R: {wxid_B, msg}
    R->>R: æƒé™æ£€æŸ¥ â†’ trusted
    R->>DM: ensureContainer(wxid_B, trusted)
    Note over DM: å®¹å™¨Bå·²å­˜åœ¨ä¸”è¿è¡Œä¸­
    R->>DB: docker exec claude --print msg
    Note over DB: Claudeå¯ä»¥æ‰§è¡Œä»£ç <br/>å—é™ç½‘ç»œ(ä»…API)<br/>æ–‡ä»¶å†™å…¥ /workspace
    DB-->>R: "å·²åˆ›å»º crawler.py..."
    R-->>W: å›å¤
    W-->>B: "å·²åˆ›å»º crawler.py..."

    Note over DA,DC: âš ï¸ å¥½å‹Aä¸å¥½å‹Bçš„å®¹å™¨<br/>å®Œå…¨éš”ç¦»ï¼Œäº’ä¸å¯è§

    C->>W: "/containers"
    W->>R: ç®¡ç†å‘½ä»¤
    R->>DM: listContainers()
    DM-->>R: å®¹å™¨åˆ—è¡¨
    R-->>W: "ğŸ³ å®¹å™¨A: Up 5min\nğŸ³ å®¹å™¨B: Up 2min"
    W-->>C: å®¹å™¨çŠ¶æ€

    C->>W: "/destroy å¥½å‹A"
    W->>R: ç®¡ç†å‘½ä»¤
    R->>DM: destroyContainer(wxid_A)
    DM->>DA: docker rm -f
    Note over DA: å®¹å™¨é”€æ¯<br/>workspaceæ•°æ®ä¿ç•™
    R-->>W: "ğŸ—‘ï¸ å·²é”€æ¯"
    W-->>C: "å·²é”€æ¯å¥½å‹Açš„å®¹å™¨"
